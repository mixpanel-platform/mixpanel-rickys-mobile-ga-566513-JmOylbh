<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
        <div id="eventName" style="float: left;"></div>
        <div id="dividendInterval" style="float: left;"></div>
        <div style="clear: left"></div>
        <div id="divisorInterval" style="float: left;"></div>
        <div style="clear: left"></div>
        <div style="clear: both;"></div>
        <div id="graph"></div>
    </div>
    <script>
      MP.api.ready(function() {
        // replace with event name of your choice
        var eventName = $('#eventName').MPEventSelect();
        // Setting our intervals
        var divisorOptions = {
          items: [
            {label: 'Weekly', value: 'week'},
            {label: 'Monthly', value: 'month'},
          ]
        };

        var dividendOptions = {
          items: [
            {label: 'Daily', value: 'day'},
            {label: 'Weekly', value: 'week'},
            {label: 'Monthly', value: 'month'},
          ]
        };

        var divisorInterval = $('#divisorInterval').MPSelect(divisorOptions);
        var dividendInterval = $('#dividendInterval').MPSelect(dividendOptions);

        // Check that eventName is defined
        var propCheck = function () {
          if (eventName.val()){
            runQuery();
          }
        };

        // Make 2 segmentation queries
        var runQuery = function() {
          var $dividend = MP.api.segment(eventName.val(), {
            from: moment().subtract(30, 'days'),
            to: moment().subtract(1, 'days'),
            unit: dividendInterval.MPSelect('value'),
            type: 'unique'
          });


          var $divisor = MP.api.segment(eventName.val(), {
            from: moment().subtract(30, 'days'),
            to: moment().subtract(1, 'days'),
            unit: divisorInterval.MPSelect('value'),
            type: 'unique'
          });
          // Wait till the segmentation queries finish
          $.when($dividend, $divisor).done(function(dividend, divisor) {
            var data = {};
            var eventStr = eventName.val()
            data[eventStr] = {};
            // Set our divisor dates and report them backgrounds
            var divisorDates = _.keys(divisor.values()[eventStr]).sort().reverse()
           /* Iterate through each divisor date to check whether it is greater
              than the dividend. If so divide and store that data on the dividend
              date. We loop backwards through the divisor to only divide dates
              that are after our definition of a week
           */
            _.each(divisorDates, function(divisorDate) {
              _.each(_.keys(dividend.values()[eventStr]), function(divDate){
                if (divDate <= divisorDate) {
                  denominator =  divisor.values()[eventStr][divisorDate];
                  numerator = dividend.values()[eventStr][divDate];
                  // Check for dividing by 0, in which case we do not include
                  if (denominator != 0) {
                    data[eventStr][divDate] =  numerator / denominator;
                  }
                }
              });
            });
            var chart = $('#graph').MPChart({ chartType: 'line' });
            chart.MPChart('setData', data);
          });
        };

      eventName.on('change', propCheck);
      divisorInterval.on('change', propCheck);
      dividendInterval.on('change', propCheck);
    });
    </script>
  </body>
</html>
